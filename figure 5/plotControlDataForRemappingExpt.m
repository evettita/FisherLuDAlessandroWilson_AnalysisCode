%plotControlDataForRemappingExpt
%
% Plot the control data set for 2 bar remapping, also look at correaltion
% between different OL/CL tuning curves and linear regression of the chnage
% in tuning following 2 bar experience.   Using the same code as the
% experimental plotting
%
%
% Yvette Fisher 12/16/18
clear all; close all
ephysSettings;

% Dec 2018 submission controls::: only 1 open loop trials used both for pre-training and post-training Load / store tuning curve variables
OL_early = [-1.64659878700000,-1.50207641100000,-1.01812324600000,-2.05653617500000,-1.74890733000000,-2.07390713200000,0.165813792000000,-0.368580667000000,-0.478503952000000,0.750382740000000,-0.272583123000000,1.81317173100000,0.648508473000000,0.763373480000000,0.0538313430000000,0.209661912000000,-0.625084960000000,1.29625947100000,-2.53216240000000,-0.774190466000000,-0.0311691530000000,-0.967835772000000,0.317071461000000,-0.133707534000000,-1.80120641100000,-2.95872832400000,-2.98922548100000,-3.56451738500000,-1.34184399800000,-4.50385624000000,-3.44890910100000,-3.03102128600000,-1.27817524200000,-2.44290877400000,0.277854670000000;-2.49947127300000,-1.44858955300000,-2.35029262500000,-3.75101575800000,-3.99567050500000,-4.39979716400000,-2.96350664200000,-2.85947721300000,-1.90371359200000,-3.66712487300000,-2.75698278500000,-1.33715033000000,-0.392759315000000,-0.139431324000000,0.0889353700000000,1.90983855300000,1.01057015900000,-0.284563404000000,0.612346539000000,0.307217604000000,-0.294778675000000,-1.07134265400000,0.317208709000000,0.301602599000000,-0.643899104000000,0.181412539000000,-0.696353095000000,-0.898248267000000,-1.08901412600000,-1.83382215100000,-1.05149905600000,-0.0656886210000000,-2.13558551000000,-2.18945467700000,-0.785892151000000;1.40829050200000,-0.0169311950000000,-0.651367787000000,-0.773898971000000,-0.931495081000000,0.562982077000000,-0.483790969000000,2.03921414200000,1.22335611900000,1.50078652900000,1.83149535000000,-0.0313536660000000,-0.0705166400000000,-1.55793976200000,-1.58462431100000,-1.40365182200000,-1.74116676600000,-1.53455480900000,-1.05545910100000,-1.51140712500000,-1.36960830700000,0.139041921000000,-1.09192965200000,-1.47887672000000,-2.01333239800000,-2.61747144800000,-2.07050460600000,-2.19714090400000,-1.60544638300000,-2.13558668200000,-2.71755445800000,-1.51941354700000,-1.29214558900000,-1.44248097000000,-1.22421733600000;-1.35840226100000,-1.00162853200000,-1.36423205900000,-1.61495267500000,-1.19782237800000,-1.83564805000000,-1.46190020800000,-2.21128929500000,-1.08833139100000,-1.00671633300000,-0.930263765000000,-0.460352505000000,-0.181657973000000,-0.770994944000000,-0.729843111000000,-1.01005367800000,-1.36859852400000,-0.996337253000000,-0.595573869000000,-0.804908932000000,-0.664567640000000,-0.504033431000000,-0.696788993000000,-0.679562666000000,-1.12631368500000,-0.920376640000000,-0.832633240000000,-0.782162100000000,-0.594198898000000,-1.21657577700000,-0.586711123000000,0.101421528000000,0.526537357000000,-0.283105521000000,0.0497257060000000];
CL_early = [-42.1787337800000,-38.9274407500000,-43.7657453100000,-42.2302255300000,-42.3658971800000,-38.2989242300000,-40.5222248900000,-41.9596862300000,-42.3887524700000,-40.5508751900000,-41.5092831000000,-38.7761798300000,-38.9813575600000,-44.0485209500000,-43.7444504100000,-42.5216690300000,-43.4190270000000,-44.3774910000000,-42.2012669800000,-42.8861957400000,-41.4637303400000,-40.4606416100000,-41.4263912400000,-41.5124280100000,-43.4735434600000,-43.1291241700000,-43.7036970300000,-45.0861050500000,-45.6898985800000,-46.6828566500000,-47.9674127900000,-45.4987117900000,-42.4976234900000,-43.7717021300000,-45.1724244400000;-40.3376592200000,-42.5549995300000,-43.3052540700000,-43.2386474000000,-41.9543219500000,-41.1155497400000,-40.8047767200000,-39.2978095400000,-42.7603474000000,-41.9713036400000,-42.7199876500000,-40.5193030100000,-39.3154245500000,-37.5876608100000,-37.0379071600000,-37.0883773700000,-36.9222416400000,-36.0634800900000,-38.4309855100000,-36.5165487800000,-36.5308090200000,-37.9817629900000,-37.3020033900000,-37.4522280300000,-37.1118420500000,-36.0095111200000,-37.7808054000000,-37.6692245100000,-38.6455820600000,-36.7330736200000,-33.9961136500000,-37.3716105900000,-37.7141429500000,-36.6649540900000,-39.4501526800000;-40.8594028000000,-40.1933559300000,-40.0749775200000,-40.6557128600000,-40.0993910900000,-41.9691351200000,-40.5327026900000,-39.1709939300000,-39.7251515200000,-39.2826412400000,-43.8561078600000,-40.9870782900000,-39.5337047100000,-40.4537908300000,-41.5325133400000,-43.2283892800000,-43.8578128100000,-42.6323134100000,-41.4172621700000,-41.5786376200000,-42.1527490900000,-46.4017658400000,-42.1626683100000,-40.8740486700000,-45.4166503800000,-45.6860265200000,-44.5853931900000,-43.7049259100000,-43.4642119700000,-42.1255006200000,-42.2767400300000,-41.8639010100000,-42.2161233800000,-40.9711797200000,-41.3199950400000;-33.3472736100000,-33.2320771700000,-33.9345321400000,-33.6866030100000,-34.5455985000000,-35.1691248400000,-34.3203616800000,-34.9300548300000,-34.8157152300000,-34.9856891500000,-34.7949468200000,-34.9882362900000,-35.4382901500000,-35.0715303800000,-34.5404612700000,-33.3527411400000,-34.2763772500000,-34.6336498300000,-34.8450743000000,-35.4999674300000,-34.8497034300000,-34.8009750800000,-34.6854317000000,-34.3148079700000,-34.8251564800000,-34.9884671800000,-34.9788887300000,-34.3623965700000,-35.3805397400000,-33.9885035400000,-33.7049244900000,-34.1706023600000,-33.8057201900000,-33.8204588500000,-33.7531143900000];
OL_late = [-1.01559467600000,0.806243205000000,-1.09375365400000,-0.380284186000000,0.174813878000000,-2.04917981100000,0.839439055000000,-0.825371194000000,1.25119473300000,0.688889798000000,-0.333110564000000,0.929992477000000,-0.0627801660000000,1.64319812700000,-2.15075068600000,-1.35994707600000,-1.37066145400000,-0.0167074670000000,-1.09737371800000,0.482089934000000,0.464466612000000,-1.27851116900000,-1.38721360000000,-1.07428899600000,0.149942030000000,-1.92182261500000,-1.65229717100000,-4.07512482900000,-3.03294983800000,-2.50307887600000,-1.54007375000000,-2.24154733000000,-3.29404259500000,-1.35939393500000,-1.02914954800000;-3.55413954700000,-2.98167375800000,-2.82960926000000,-4.27862990200000,-5.21401040700000,-3.07510467700000,-3.94409574100000,-2.47544476000000,-3.89693135700000,-2.61270038500000,-1.50401825800000,-2.37797444300000,-0.350920628000000,-0.670134208000000,1.73639625800000,1.13776653900000,1.76128082300000,1.36336661500000,1.87078047200000,-0.820248762000000,-0.265032330000000,-0.129279606000000,0.339445556000000,-0.361893105000000,-0.652451018000000,0.125720326000000,-0.662649259000000,-1.55939369300000,-0.222996999000000,-1.49167346400000,-0.505343108000000,-0.0620418250000000,0.672412684000000,-0.0934373100000000,0.530255035000000;1.38848244400000,1.03623838400000,0.699891098000000,0.329003999000000,1.13443128200000,0.709428483000000,2.88761361800000,2.84557667800000,2.95548432500000,0.547942914000000,1.18259795000000,0.438399473000000,-0.920888795000000,-1.61181974300000,-2.56333791900000,-1.25334951300000,-0.599539416000000,-1.33814822000000,-1.64436824300000,-2.74775735800000,-1.21416734100000,-1.58152347500000,-1.38946368100000,-2.07560670900000,-0.713405915000000,-1.55639913100000,-2.00392900500000,-3.57180443400000,-2.42101405800000,-1.33671554800000,-1.39117473400000,-1.86032315300000,-1.40179105200000,-1.84824806700000,-1.17945071200000;0.359379820000000,-0.0410687740000000,-0.217336925000000,-0.515335416000000,0.149137572000000,0.0606596590000000,0.952518474000000,0.651614975000000,0.969515855000000,1.18575324600000,-0.317459328000000,-0.0435031830000000,-1.26597683000000,-2.67293455000000,-1.61968208200000,-2.44166558500000,-1.96919484600000,-1.94480737200000,-1.93868642600000,-1.38562897000000,-2.59400924200000,-2.03313131600000,-1.88690756000000,-2.57976064500000,-2.75749378200000,-1.57623029500000,-2.86299914100000,-1.82282218000000,-2.49740528000000,-1.86483649500000,-0.355465290000000,-0.117035170000000,-0.630663516000000,-0.0865974020000000,-0.614058822000000];
CL_late = [-40.0885177000000,-38.2238909100000,-39.5624974800000,-44.2758593800000,-44.2583141500000,-42.8625035700000,-40.7712649500000,-45.6093403800000,-41.1795571200000,-41.1262984300000,-40.9506927100000,-41.4235043600000,-41.1160031800000,-44.2401175500000,-42.5027438000000,-44.3560790100000,-43.9498172400000,-42.3352297500000,-44.1154027700000,-41.1799584000000,-42.0231029600000,-40.9792959400000,-41.5215413600000,-40.9842913700000,-40.0836855400000,-40.4904005900000,-42.5233874400000,-42.9473253700000,-43.5706466200000,-45.2823137300000,-45.2313327600000,-44.5449865900000,-43.4333079300000,-42.1484550800000,-43.3492208000000;-40.9918979400000,-41.3468520000000,-42.7268331400000,-41.4822852900000,-41.9189234000000,-40.6966499000000,-42.4258724400000,-41.5012374000000,-40.5090518100000,-40.7860849700000,-39.2529895700000,-40.5666490300000,-37.8875301600000,-37.2894357800000,-37.2577391200000,-40.0701392400000,-38.3612912600000,-36.5793778100000,-37.9188031100000,-37.7447527600000,-34.0982511000000,-38.3583936600000,-39.8923680800000,-40.3860291700000,-38.0302329700000,-37.3095317900000,-37.6772981200000,-37.5769018900000,-39.8098400900000,-38.0020108900000,-39.8661614400000,-37.4239089400000,-37.7356820700000,-40.1079147900000,-40.4418974400000;-38.4070326800000,-37.9753550500000,-37.5210779200000,-37.4813516800000,-38.2089171100000,-40.6817850500000,-41.3659017000000,-38.4419080100000,-38.3246848600000,-38.4112663900000,-39.0538047700000,-38.3412689100000,-36.6774358200000,-37.3152156700000,-37.3920861400000,-37.9337206200000,-38.4058597700000,-37.4551316700000,-38.9720032900000,-39.1600154000000,-39.6451247900000,-43.2335021100000,-42.6266781300000,-42.1808532500000,-41.8718084700000,-41.1982916400000,-42.4759108500000,-43.1484599600000,-41.7890132400000,-40.5947092200000,-42.8991651700000,-42.4560382600000,-41.0456783900000,-40.0960725500000,-41.6013247600000;-34.7034542800000,-34.3651071600000,-35.6129850700000,-36.4481145700000,-35.8598275200000,-35.1681132000000,-36.2712231300000,-34.6304345800000,-31.1553588700000,-33.4997276500000,-31.2682999300000,-34.7842011700000,-33.5798027100000,-32.9281568800000,-31.8947679600000,-36.2584675800000,-35.6456118100000,-36.1293382300000,-35.4742357200000,-34.8503981900000,-34.3010012800000,-34.3550540700000,-34.5011820600000,-34.3729054900000,-33.6281607800000,-37.0392729700000,-35.6964430100000,-35.1103280600000,-36.1331890300000,-35.8091357500000,-35.5132018300000,-34.6160976900000,-34.8753605400000,-34.9363245200000,-33.4736189500000];
flyNum = [107;132;278;279];



DEGREE_PER_LED_SLOT = 360 / 96;  % fixed from YEF math error on 1/3/18
POSSIBLE_BAR_LOCATIONS = 2:2:71;
MIDLINE_POSITION = 34; % LED position where the fly is aligned to for all 270 deg EPG recordings 11/2017  - present
barPositionDegreesFromMidline = ( POSSIBLE_BAR_LOCATIONS - MIDLINE_POSITION ) * DEGREE_PER_LED_SLOT;

%% Loop over all the recording in the data set and plot data/analysis
close all;
corrOLBeforeToCL1bar = [];
corrOLBeforeToCL2bar = [];
corrOLafterToCL1bar = [];
corrOLafterToCL2bar = [];
netVisualTuningChange = [];
normVisualTuningChange = [];
voltageRange2barCL = [];
voltageRange1barCL = [];
voltageRangeBeforeOL = [];
voltageRangeAfterOL = [];


for i = 1: length ( OL_early(:,1) )
    
    % Smooth the data with median filter if user wants to:
    % order for median filter smooth
    ORDER_MEDFILTER =2; %    
        currCL_1bar = medfilt1( CL_early(i,:), ORDER_MEDFILTER, 'truncate'); % Median filtering of the trace
        currCL_2bar = medfilt1( CL_late(i,:), ORDER_MEDFILTER, 'truncate'); % Median filtering of the trace
        
        currOL_before = medfilt1( OL_early(i,:), ORDER_MEDFILTER, 'truncate'); % Median filtering of the trace
        currOL_after = medfilt1( OL_late(i,:), ORDER_MEDFILTER, 'truncate'); % Median filtering of the trace

    
    % find change for smoothed curves after - before for each tuning curve
    smoothedDifference_OL = currOL_after - currOL_before;
    smoothedDifference_CL = currCL_2bar - currCL_1bar;
     % find change for not smoothed curves after - before for each tuning curve
    nonSmoothedDifference_OL = OL_late(i,:) - OL_early(i,:);
    nonSmoothedDifference_CL = CL_late(i,:) - CL_early(i,:);
    
        
    % save the values we need for the next analysis/plots below:
    % integral of absolute values of (after-before OL)
    netVisualTuningChange(i) = sum ( abs( smoothedDifference_OL ) );
    netVisualTuningChangeByBarLoc(i) = (sum ( abs( smoothedDifference_OL ) ) ) / length( barPositionDegreesFromMidline );
    
    [R_OL, P] = corrcoef( currOL_before,  currOL_after );
     RvalueBetweenOL(i) = R_OL( 1, 2);
     
     shapeChange_OL(i) = 1 - (RvalueBetweenOL(i))^2;
    
    
    % Plot the tuning curves for current fly together on the same figure, with axes rescaled in
    % a good way for interpretation
    figure('Position',[50, 50, 1000, 800]); set(gcf, 'Color', 'w');
    
    yAxesMax =  max([currCL_1bar currCL_2bar]);
    yAxesMin =  min([currCL_1bar currCL_2bar]);
    
    % CL 1 bar
    subplot( 4, 2, 1)
    plot( barPositionDegreesFromMidline, currCL_1bar , '-r' );
    maxMinusMin_CLbefore = max(currCL_1bar) - min(currCL_1bar);
    %title(['1 bar closed loop, max-min:' num2str(maxMinusMin_CLbefore) ' (mV)' ] );
    niceaxes; box off
    xlim([ -120 135])
    ylim( [ yAxesMin yAxesMax] );
    
    % CL 2 bar
    subplot(4, 2, 3)
    plot( barPositionDegreesFromMidline, currCL_2bar , '-r');
    %title(' 2 bar closed loop' );
    niceaxes; box off
    xlim([ -120 135])
    ylim( [ yAxesMin yAxesMax] );
    
    yAxesMax =  max([currOL_before currOL_after]);
    yAxesMin =  min([currOL_before currOL_after]);
    
    % OL before 1 bar
    subplot( 4, 2, 2)
    plot( barPositionDegreesFromMidline, currOL_before );
    maxMinusMin_OLbefore = max(currOL_before) - min(currOL_before);
    %title([' open loop (before), max-min:' num2str(maxMinusMin_OLbefore) ' (mV)' ] );
    niceaxes; box off
    xlim([ -120 135])
    ylim( [ yAxesMin yAxesMax] );
    
    % OL after 2 bar
    subplot(4, 2, 4)
    plot( barPositionDegreesFromMidline, currOL_after );
    %title(' open loop (after)' );
    niceaxes; box off
    xlim([ -120 135])
    ylim( [ yAxesMin yAxesMax] );
    
    % range of 2Bar CL voltage tuning
    voltageRange2barCL(i) =  max(currCL_2bar) - min( currCL_2bar);
    % range of 1 bar CL voltage tuning
    voltageRange1barCL(i) =  max(currCL_1bar) - min( currCL_1bar);
        % range of before OL voltage tuning
    voltageRangeBeforeOL(i) =  max(currOL_before) - min( currOL_before);
    % range of after OL voltage tuning
    voltageRangeAfterOL(i) =  max(currOL_after) - min( currOL_after);
    
    normCurrOL_before = ( currOL_before - min( currOL_before ) ) / ( max(currOL_before) - min( currOL_before ) );
    normCurrOL_after = ( currOL_after - min( currOL_after ) ) / ( max(currOL_after) - min( currOL_after ) );
    normDifference_OL = normCurrOL_after - normCurrOL_before;
    
    normVisualTuningChange(i) = sum ( abs( normDifference_OL ) );
    %normVisualTuningChange(i) = netVisualTuningChange(i) / ( voltageRangeBeforeOL(i) + voltageRangeAfterOL(i) );
    % find change after - before for each tuning curve
    percentChange_OL = (currOL_after - currOL_before) ./ currOL_before;
    precentVisualTuningChange(i) = sum ( abs( percentChange_OL ) );
    
    yAxesMax =  max([smoothedDifference_OL smoothedDifference_CL]);
    yAxesMin =  min([smoothedDifference_OL smoothedDifference_CL]);
    
    % plot CL change  after - before plots below
    subplot(4, 2, 5)
    % add grey dotted line at 0
    plot( barPositionDegreesFromMidline, zeros( 1, length(barPositionDegreesFromMidline) ), 'Color', [ 0.7 , 0.7, 0.7] ); hold on;
    plot( barPositionDegreesFromMidline, smoothedDifference_CL ,'Color', [ 0 , 0, 0] );
    %text(barPositionDegreesFromMidline(1),max( smoothedDifference_CL ) ,['change:' newline ' after- before (CL)'], 'Color', [ 0 , 0, 0])
    
    niceaxes; box off
    xlim([ -120 135])
    ylim( [ yAxesMin yAxesMax] );
    
    % plot CL change  after - before plots below
    subplot(4, 2, 6)
    % add grey dotted line at 0
    plot( barPositionDegreesFromMidline, zeros( 1, length(barPositionDegreesFromMidline) ), 'Color', [ 0.7 , 0.7, 0.7] ); hold on;
    plot( barPositionDegreesFromMidline, smoothedDifference_OL ,'Color', [ 0 , 0, 0] );
    %text(barPositionDegreesFromMidline(1),max( smoothedDifference_OL ) ,['change:' newline ' after- before (OL)'], 'Color', [ 0 , 0, 0])
    
    niceaxes; box off
    xlim([ -120 135])
    ylim( [ yAxesMin yAxesMax] );
    
    suptitle( ['flyNum' num2str( flyNum(i) )] )
    
    % Analyze changes in tuning as scatter
    subplot(4, 2, 7)
    scatter( smoothedDifference_CL, smoothedDifference_OL, 'filled'); hold on;
    
    xlim( [ min(smoothedDifference_CL) ; max(smoothedDifference_CL) ]);
    xlabel( 'closed loop (after-before)');
    
    ylim( [ min(smoothedDifference_OL) ; max(smoothedDifference_OL) ]);
    ylabel( 'open loop (after-before)');
    
    plot( [min(smoothedDifference_CL) ; max(smoothedDifference_CL)], [0, 0], 'k'); hold on;
    plot( [0, 0], [ min(smoothedDifference_OL) ; max(smoothedDifference_OL)], 'k' );
    
    % linear regression of unsmoothed difference:
    fitModel = fitlm( nonSmoothedDifference_CL,  nonSmoothedDifference_OL,  'linear' );
    slope = fitModel.Coefficients.Estimate(2);
    
    pvalOfSlope = fitModel.Coefficients.pValue(2);    
    slopeOLvsCLDifferenceUnSmoothed(i) = slope;

     [R, P] = corrcoef( nonSmoothedDifference_CL,  nonSmoothedDifference_OL );
     Rvalue(i) = R( 1, 2);
    pvalOfSlopeAcrossFliesUnsmoothed( i ) = pvalOfSlope;
    
     % linear regression of smoothed difference:
    fitModel = fitlm( smoothedDifference_CL,  smoothedDifference_OL,  'linear' );
    slopeSmooth = fitModel.Coefficients.Estimate(2);
    pvalOfSlopeSmooth = fitModel.Coefficients.pValue(2);
    title([ 'Smoothed: Slope:'  num2str(slopeSmooth)   ' pval:' num2str(pvalOfSlopeSmooth) ])
    
    slopeOLvsCLDifferenceSmoothed(i) = slopeSmooth;
     [R, P] = corrcoef( smoothedDifference_CL,  smoothedDifference_OL );
     Rvalue(i) = R( 1, 2);
    pvalOfSlopeAcrossFliesSmoothed( i ) = pvalOfSlopeSmooth;
    
    title([ 'R: ' num2str( Rvalue(i) ) ' Slope:'  num2str(slope)   ' pval:' num2str(pvalOfSlope) ])
    
    
% % % % %     % save current plot
%         dir = '/Users/evettita/Dropbox (HMS)/FisherLuWilson ms/figure 5/ephyRemappingControls_forFigure5_181216/';
%         fileName = [ dir 'flyNum' num2str( flyNum(i) ) '_controlExamples.eps' ];
%         print( fileName, '-dpdf');
    
end

